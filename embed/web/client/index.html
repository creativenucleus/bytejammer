<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>ByteJammer</title>

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="jtruk/RiFT">

        <link href="/static/package/bootstrap-5.3.2-dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/style/default.css" />
        <link rel="icon" type="image/x-icon" href="/static/media/favicon/favicon.ico">
        <script src="/static/javascript/bytejammer.js"></script>    

        <script>
            const ws = new BjmrWebSocket('{{session_key}}')
            const ajax = new BjmrAjax('{{session_key}}')

            let IDENTITIES = null;

            const refreshViewIdentities = () => {
                const elSelect = document.getElementById("identity-id-select");
                while (elSelect.firstChild) {
                    elSelect.removeChild(elSelect.firstChild);
                }

                for (const [key, identity] of Object.entries(IDENTITIES)) {
                    const elOption = document.createElement("option");
                    elOption.value = key;
                    elOption.text = identity['display-name'];

                    elSelect.appendChild(elOption);
                }
            }

            const fetchIdentites = async () => {
                // #TODO: catch errors
                const res = await ajax.makeReq("GET", "identity");
                if (res.ok) {
                    IDENTITIES = res.data;
                    refreshViewIdentities();
                    refreshVisibility();
                }
            }

            const refreshVisibility = () => {
                if (IDENTITIES===null) {
                    // Not yet initialised
                    document.getElementById("section-create-identity").style.display = "none";
                    document.getElementById("section-join-server").style.display = "none";
                } else if (Object.keys(IDENTITIES).length == 0) {
                    // Currently, only one identity is supported for clients
                    document.getElementById("section-create-identity").style.display = "block";
                    document.getElementById("section-join-server").style.display = "none";
                } else {
                    document.getElementById("section-create-identity").style.display = "none";
                    document.getElementById("section-join-server").style.display = "block";
                }
            }

            window.onload = () => {
                refreshVisibility();
                fetchIdentites();

                document.getElementById("create-identity").addEventListener("submit", (e) => {
                    e.preventDefault();
                    const data = getDataFromForm(e.target)
                    e.target.reset();
                    (async() => {
                        const res = await ajax.makeReq("POST", "identity", data)
                        fetchIdentites();
                    })();
                });

                document.getElementById("join-server").addEventListener("submit", (e) => {
                    e.preventDefault();
                    const data = getDataFromForm(e.target)
                    e.target.reset();
                    (async() => {
                        const res = await ajax.makeReq("POST", "join-server", data)
                        fetchIdentites();
                    })();
                });

                const handleMsgServerStatus = (data) => {
                    // #TODO
                    console.log(data);
                    setWsRemoteStatusText('ok', 'connected');
                }

                const handleMsgLog = (data) => {
                    // TODO: shim server time?
                    addToLog(data.Msg);
                }

                let conn = ws.open("ws://" + document.location.host + "/{{session_key}}/ws-client");
                if(!conn) {                    
                    setWsLocalStatusText('error', "Your browser does not support WebSockets");
                    // TODO: Bigger error?
                } else {                    
                    setWsLocalStatusText('ok', "Initialised");

                    conn.onerror = (error) => {
                        addToLog("Local websocket connection error");
                    }

                    conn.onopen = () => {
                        addToLog("Connected to local");
                        setWsLocalStatusText('ok', "Open")
                    }
                    
                    conn.onclose = (event) => {
                        addToLog("Disconnected from local");
                        if (event.wasClean) {
                            setWsLocalStatusText('ok', `Closed: Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        } else {
                            // e.g. server process killed or network down
                            // event.code is usually 1006 in this case
                            setWsLocalStatusText('error', "Closed: Unexpected disconnect");
                        }
                    };

                    conn.onmessage = (evt) => {
                        const msg = JSON.parse(evt.data);
                        console.log(msg)
                        switch(msg.type) {
                            case "client-status":
//                                handleMsgServerStatus(msg.data)
                                break;

                            case "log":
                                handleMsgLog(msg.log);
                                break;

                            default:
                                console.error(`Unhandled message type ${msg.type}`);
                        }
                    };
                }
            };
        </script>
    </head>
    <body>
        <div class="container">
            <h1><img src="/static/media/bytejammer-icon.png" alt="ByteJammer icon"> ByteJammer / {{release_title}} edition</h1>

            <div id="section-create-identity" class="mt-4 mb-4">
                <div class="card">
                    <div class="card-header text-bg-primary">
                        <h2>Create an Identity</h2>
                    </div>
                    <div class="card-body">
                        <form id="create-identity">
                            <div class="row mb-3">
                                <label for="display-name" class="col-sm-3 col-form-label text-end">Display Name</label>
                                <div class="col-sm-9">
                                    <input value="" class="form-control" id="display-name" name="display-name">
                                    <span id="display-name-help" class="form-text">
                                        This name will be shown for you during the jams
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="offset-sm-3">
                                    <button type="submit" class="btn btn-primary">Create</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="section-join-server" class="mt-4 mb-4">
                <div class="card">
                    <div class="card-header text-bg-primary">
                        <h3>Join a Server</h3>
                    </div>
                    <div class="card-body">
                        <form id="join-server">
                            <div class="row mb-3">
                                <label for="host" class="col-sm-3 col-form-label text-end">Host</label>
                                <div class="col-sm-9">
                                    <input value="localhost" class="form-control" id="host" name="host">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="port" class="col-sm-3 col-form-label text-end">Port</label>
                                <div class="col-sm-9">
                                    <input type="number" value="4545" class="form-control" id="port" name="port">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="identity-id-select" class="col-sm-3 col-form-label text-end">Identity</label>
                                <div class="col-sm-9">
                                    <select class="form-select" aria-label="identity-id" id="identity-id-select" name="identity-id">
                                    </select>
                                    <span id="identity-id-help" class="form-text">
                                        The server will receive this jammer name
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="offset-sm-3">
                                    <button type="submit" class="btn btn-primary">Join</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>    
            </div>

            <div class="card mt-4 mb-4">
                <div class="card-header text-bg-secondary">
                    <h2>Log</h2>
                </div>
                <div class="card-body">
                    <div id="log"></div>
                </div>
            </div>

            <div class="fixed-bottom">
                <div class="container" id="connection-status-panel">
                    <div>Connection to Local: <span id="ws-local-status" class="fw-bold">(none)</span></div>
                    <div>Connection to Remote: <span id="ws-remote-status" class="fw-bold">(none)</span></div>
                </div>
            </div>
        </div>
    </body>

    <script src="/static/package/bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>    
</html>