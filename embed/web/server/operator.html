<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>ByteJammer</title>

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="jtruk/RiFT">

        <link href="/static/package/bootstrap-5.3.2-dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="/static/style/default.css" />
        <link rel="icon" href="/static/media/favicon/favicon.ico">
        <script src="/static/javascript/bytejammer.js"></script>    

        <script type="text/javascript">
            const ws = new BjmrWebSocket('{{session_key}}')
            const ajax = new BjmrAjax('{{session_key}}')

            let CLIENTS = {};
            let FANTASY_MACHINES = {};

            const handleMsgServerStatus = (data) => {
                let html = '';
                if(!data.Clients || data.Clients.length == 0) {
                    html = "<div>No clients connected</div>";
                } else {
                    html += "<table class=\"table\">";
                    html += `<thead>`;
                    html += `<tr>`;
                    html += `<th>Name</th>`;
                    html += `<th>Status</th>`;
                    html += `<th>Last Ping Time</th>`;
                    html += `</tr>`;
                    html += `</thead>`;
                    html += `<tbody>`;
                    for (const client of data.Clients) {
                        const rowClass = client.Status == "waiting" ? "table-warning" : "table-success";
                        html += `<tr class="${rowClass}">`;
                        html += `<td>${client.DisplayName}</td>`;
                        html += `<td>${client.Status}</td>`;
                        html += `<td>${client.LastPingTime}</td>`;
                        html += `<td>`
                        html += `<button class="btn btn-primary">Start New TIC</button> `;
                        html += `<button class="btn btn-primary">Assign TIC</button> `;
                        html += `<button class="btn btn-primary">Decline</button> `;
                        html += `<button class="btn btn-danger">Block</button> `;
                        html += `</td>`;
                        html += `</tr>`;
                    }
                    html += `</tbody>`;
                    html += "</table>";
                }

                document.getElementById("clients").innerHTML = html;

                html = '';
                if(!data.FantasyMachines || data.FantasyMachines.length == 0) {
                    html = "<div>No fantasy machines running</div>";
                } else {
                    html += "<table class=\"table\">";
                    html += `<thead>`;
                    html += `<tr>`;
                    html += `<th>Machine</th>`;
                    html += `<th>Platform</th>`;
                    html += `<th>Status</th>`;
                    html += `<th>Jammer Name</th>`;
                    html += `<th>Last Snapshot</th>`;
                    html += `<th></th>`;
                    html += `</tr>`;
                    html += `</thead>`;
                    html += `<tbody>`;
                    for (const fantasyMachine of data.FantasyMachines) {
                        html += `<tr>`;
                        html += `<td>${fantasyMachine.MachineName}</td>`;
                        html += `<td>${fantasyMachine.Platform}</td>`;
                        html += `<td>${fantasyMachine.Status}</td>`;
                        html += `<td>${fantasyMachine.JammerDisplayName}</td>`;
                        html += `<td>${fantasyMachine.LastSnapshotTime}</td>`;
                        html += `<td>`
                        html += `<button class="btn btn-primary">Close FM</button> `;
                        html += `<button class="btn btn-primary">Disconnect Jammer</button> `;
                        html += `</td>`;
                        html += `</tr>`;
                    }
                    html += `</tbody>`;
                    html += "</table>";
                }

                document.getElementById("fantasy-machines").innerHTML = html;
            }
                
            window.onload = () => {
                document.getElementById("btn-clients").onclick = () => {
                    if (!ws.isOpen()) {
                        return false;
                    }
                    ws.sendMsg("reset-clients", "");
                    return false;
                };

                const conn = ws.open("ws://" + document.location.host + "/{{session_key}}/ws-operator");
                if(!conn) {                    
                    setWsLocalStatusText('error', "Your browser does not support WebSockets");
                    // TODO: Bigger error?
                } else {
                    setWsLocalStatusText('ok', "Initialised");

                    conn.onerror = (error) => {
                        alert(`[error]`);
                    }

                    conn.onopen = () => {
                        setWsLocalStatusText('ok', "Open")
                    }
                    
                    conn.onclose = (evt) => {
                        if (event.wasClean) {
                            setWsLocalStatusText('ok', `Closed: Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        } else {
                            // e.g. server process killed or network down
                            // event.code is usually 1006 in this case
                            setWsLocalStatusText('error', 'Closed: Connection died');
                        }
                    }

                    conn.onmessage = (evt) => {
                        const msg = JSON.parse(evt.data);
                        switch(msg.type) {
                            case "server-status":
                                handleMsgServerStatus(msg.data)
                                break;
                            default:
                                console.error(`Unhandled message type ${msg.type}`);
                        }
                    }
                }

                document.getElementById("start-tic-unassigned").addEventListener("click", (e) => {
                    e.preventDefault();
                    (async() => {
                        const res = await ajax.makeReq("POST", "fantasy-machine", {platform: "TIC-80", mode: "jammer"})
                    })();
                });

                document.getElementById("start-tic-playlist").addEventListener("click", (e) => {
                    e.preventDefault();
                    (async() => {
                        const res = await ajax.makeReq("POST", "fantasy-machine", {platform: "TIC-80", mode: "jukebox"})
                    })();
                });
            };
        </script>

        <link rel="stylesheet" href="/static/style/default.css" />
    </head>
    <body>
        <div class="container">
            <h1><img src="/static/media/bytejammer-icon.png" alt="ByteJammer icon"> ByteJammer</h1>

            <div class="card mt-4 mb-4">
                <div class="card-header">
                    <h2>This Server</h2>
                </div>
                <div class="card-body">
                    <form id="server-setup">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="message" class="form-label">Welcome Message</label>
                            </div>
                            <div class="col-auto">
                                <textarea class="form-control" id="port" name="message" aria-describedby="message"></textarea>
                            </div>
                            <div class="col-auto">
                                <span id="welcomeMessageHelp" class="form-text">
                                    When you accept people's connections, this message will be sent to them.
                                </span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4 mb-4">
                <div class="card-header">
                    <h2>Jammers</h2>
                </div>
                <div class="card-body">
                    <div id="clients"></div>
                </div>
            </div>

            <div class="card mt-4 mb-4">
                <div class="card-header">
                    <h2>Fantasy Machines</h2>
                </div>
                <div class="card-body">
                    <div id="fantasy-machines"></div>
                </div>
                <div class="card-footer">
                    <div class="btn-group">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Start Fantasy Machine
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" id="start-tic-unassigned">TIC (unassigned)</a></li>
                            <li><a class="dropdown-item" id="start-tic-playlist">TIC (playlist: LCDZ)</a></li>
                        </ul>
                    </div>
                    <div class="btn-group">                                           
                        <button id="btn-clients" class="btn btn-primary">Send IDENTIFIER CODE to Clients</button>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="fixed-bottom">
            <div class="container">
                <div>Connection to Local: <span id="ws-local-status">(none)</span></div>
            </div>
        </div>

        <script src="/static/package/bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>    
    </body>
</html>
