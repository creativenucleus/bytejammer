<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>ByteJammer</title>
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="jtruk/RiFT">

        <link href="/static/package/bootstrap-5.3.2-dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/style/default.css" />
        <link rel="icon" type="image/x-icon" href="/static/media/favicon/favicon.ico">
        <script src="/static/javascript/bytejammer.js"></script>    

        <script type="text/javascript">
            const ws = new BjmrWebSocket('{{session_key}}')
            const ajax = new BjmrAjax('{{session_key}}')

            let SERVER = null;
            let SESSIONS = {};
            let CLIENTS = {};
            let MACHINES = {};
            let SLOTS = {};

            const refreshViewSessions = () => {
                const elSelect = document.getElementById("resume-session-slug");
                while (elSelect.firstChild) {
                    elSelect.removeChild(elSelect.firstChild);
                }

                for (const [key, session] of Object.entries(SESSIONS)) {
                    const elOption = document.createElement("option");
                    elOption.value = session['slug'];
                    elOption.text = `${session['name']} ${session['started_at']} port(${session['port']})`;

                    elSelect.appendChild(elOption);
                }
            }

            const refreshViewSlots = () => {
                const elSelect = document.getElementById("slot-connection");
                while (elSelect.firstChild) {
                    elSelect.removeChild(elSelect.firstChild);
                }
                
                const elOptionCreate = document.createElement("option");
                elOptionCreate.value = '-';
                elOptionCreate.text = `(Create New)`;
                elSelect.appendChild(elOptionCreate);

                const slots = SLOTS || {};
                for (const [key, slot] of Object.entries(slots)) {
                    const elOption = document.createElement("option");
                    elOption.value = key;
                    elOption.text = `Update ${key}`;

                    elSelect.appendChild(elOption);
                }
            }
            
            const fetchSessions = async () => {
                // #TODO: catch errors
                const res = await ajax.makeReq("GET", "recent-sessions");
                if (res.ok) {
                    SESSIONS = res.data;
                    refreshViewSessions();
                    refreshVisibility();
                }
            }

            const refreshVisibility = () => {
                if (!SERVER) {
                    document.getElementById("section-launch-server").style.display = "block";
                    document.getElementById("section-server-info").style.display = "none";
                } else {
                    document.getElementById("section-launch-server").style.display = "none";
                    document.getElementById("section-server-info").style.display = "block";
                }
            }

            /*
            const onClickStartTIC = (slotId) => {
                if (!ws.isOpen()) {
                    return false;
                }
                addToLog(`Requested start machine in ${slotId}`);
                ws.sendMsg("start-machine", {
                    'start-machine': {
                        'slot': slotId
                    }
                });
                return false;
            };
            */

            const onClickConnectMachine = (machineUuid, clientUuid) => {
                if (!ws.isOpen()) {
                    return false;
                }
                addToLog(`Requested connect machine ${machineUuid} to ${clientUuid}`);
                ws.sendMsg("connect-machine-client", {
                    'machine-uuid': machineUuid,
                    'client-uuid': clientUuid,
                });
                return false;
            };

            const onClickDisconnectMachine = (machineUuid, clientUuid) => {
                if (!ws.isOpen()) {
                    return false;
                }
                addToLog(`Requested disconnect machine ${clientUuid} from ${machineUuid}`);
                ws.sendMsg("disconnect-machine-client", {
                    'machine-uuid': machineUuid,
                    'client-uuid': clientUuid,
                });
                return false;
            };

            const onClickStartMachineForClient = (clientUuid) => {
                if (!ws.isOpen()) {
                    return false;
                }
                addToLog(`Requested TIC-80 for client (${clientUuid})`);
                (async() => {
                    const res = await ajax.makeReq("POST", "machine", {platform: "TIC-80", mode: "jammer", "client-uuid": clientUuid})
                })();
            };       

            const onClickCloseMachine = (target) => {
                if (!ws.isOpen()) {
                    return false;
                }
                const uuid = target.getAttribute('data-uuid')
                addToLog(`Requested close machine ${uuid}`);
                ws.sendMsg("close-machine", {uuid: uuid});
                return false;
            };

            const handleMsgServerStatus = (data) => {
                SERVER = true;  // (echo settings)
                refreshVisibility();

                let html = `<p>Port: ${data.Port}</p>`;
                document.getElementById("server-details").innerHTML = html;

                html = '';
                if(!data.Clients || data.Clients.length == 0) {
                    html = "<div>No clients connected</div>";
                } else {
                    html += "<table class=\"table\">";
                    html += `<thead>`;
                    html += `<tr>`;
                    html += `<th>Name</th>`;
                    html += `<th>Status</th>`;
                    html += `<th>Last Ping Time</th>`;
                    html += `</tr>`;
                    html += `</thead>`;
                    html += `<tbody>`;
                    for (const client of data.Clients) {
                        const rowClass = client.Status == "waiting" ? "table-warning" : "table-success";
                        html += `<tr class="${rowClass}">`;
                        html += `<td>${client.DisplayName} ${client.ShortUuid}</td>`;
                        html += `<td>${client.Status}</td>`;
                        html += `<td>${client.LastPingTime}</td>`;
                        html += `<td>`

                            console.log(client.MachineUuid);
                        if (client.MachineUuid == "") {
                            html += `<button class="btn btn-primary" onclick="return onClickStartMachineForClient('${client.Uuid}')">Start Machine</button> `;
                            if(data.Machines && data.Machines.length > 0) {
                                html += `<div class="btn-group">`
                                html += `<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">`
                                html += `Assign Machine`
                                html += `</button>`
                                html += `<ul class="dropdown-menu">`
                                for (const machine of data.Machines) {
                                    html += `<li><a class="dropdown-item" onclick="return onClickConnectMachine('${machine.Uuid}', '${client.Uuid}')">${machine.MachineName}</a></li>`
                                }
                                html += `</ul>`
                                html += `</div> `
                            }
                            html += `<button class="btn btn-primary" onclick="alert('Not yet implemented!')">Decline</button> `;
                            html += `<button class="btn btn-danger" onclick="alert('Not yet implemented!')">Block</button> `;
                        }
                        html += `</td>`;
                        html += `</tr>`;
                    }
                    html += `</tbody>`;
                    html += "</table>";
                }

                document.getElementById("clients").innerHTML = html;

                html = '';
                SLOTS = data.Slots;
                if(!SLOTS || SLOTS.length == 0) {
                    html = "<div>No slots created</div>";
                } else {
                    html += "<table class=\"table\">";
                    html += `<thead>`;
                    html += `<tr>`;
                    html += `<th>Slot</th>`;
                    html += `<th>Status</th>`;
                    html += `<th>Machine</th>`;
                    html += `<th>Platform</th>`;
                    html += `<th>Jammer</th>`;
                    html += `<th>Last Snapshot</th>`;
                    html += `<th></th>`;
                    html += `</tr>`;
                    html += `</thead>`;
                    html += `<tbody>`;
                    for (const slot of data.Slots) {
                        let machine = ""
                        if(slot.machine) {
                            machine = `${slot.machine.MachineName}<br>(Process: ${slot.ProcessID})`;
                        } else {
                            machine = `(none)`;
                        }

                        html += `<tr>`;
                        html += `<td>${slot.Id}</td>`;
                        html += `<td>${slot.Status}</td>`;
                        html += `<td>${machine}</td>`;
                        html += `<td>${slot.Platform}</td>`;
                        html += `<td>${slot.JammerDisplayName}</td>`;
                        html += `<td>${slot.LastSnapshotTime}</td>`;
                        html += `<td>`
//                        html += `<button class="btn btn-primary" onclick="return onClickCloseMachine(this);" data-uuid="${machine.Uuid}">Close Machine</button> `;
//                        html += `<button class="btn btn-primary" onclick="return onClickDisconnectMachine('${machine.Uuid}', '${machine.ClientUuid}')">Disconnect Jammer</button> `;
                        html += `</td>`;
                        html += `</tr>`;
                    }
                    html += `</tbody>`;
                    html += "</table>";
                }
                document.getElementById("slots").innerHTML = html;
                refreshViewSlots();

                html = '';
                if(!data.Machines || data.Machines.length == 0) {
                    html = "<div>No machines running</div>";
                } else {
                    html += "<table class=\"table\">";
                    html += `<thead>`;
                    html += `<tr>`;
                    html += `<th>Machine</th>`;
                    html += `<th>Platform</th>`;
                    html += `<th>Status</th>`;
                    html += `<th>Jammer Name</th>`;
                    html += `<th>Last Snapshot</th>`;
                    html += `<th></th>`;
                    html += `</tr>`;
                    html += `</thead>`;
                    html += `<tbody>`;
                    for (const machine of data.Machines) {
                        html += `<tr>`;
                        html += `<td>${machine.MachineName}<br>(Process: ${machine.ProcessID})</td>`;
                        html += `<td>${machine.Platform}</td>`;
                        html += `<td>${machine.Status}</td>`;
                        html += `<td>${machine.JammerDisplayName}</td>`;
                        html += `<td>${machine.LastSnapshotTime}</td>`;
                        html += `<td>`
                        html += `<button class="btn btn-primary" onclick="return onClickCloseMachine(this);" data-uuid="${machine.Uuid}">Close Machine</button> `;
                        html += `<button class="btn btn-primary" onclick="return onClickDisconnectMachine('${machine.Uuid}', '${machine.ClientUuid}')">Disconnect Jammer</button> `;
                        html += `</td>`;
                        html += `</tr>`;
                    }
                    html += `</tbody>`;
                    html += "</table>";
                }

                document.getElementById("machines").innerHTML = html;
            }

            const handleMsgLog = (data) => {
                // TODO: shim server time?
                addToLog(data.Msg);
            }

            window.onload = () => {
                refreshVisibility();
                fetchSessions();

                const conn = ws.open("ws://" + document.location.host + "/{{session_key}}/ws-operator");
                if(!conn) {                    
                    setWsLocalStatusText('error', "Your browser does not support WebSockets");
                    // TODO: Bigger error?
                } else {
                    setWsLocalStatusText('ok', "Initialised");

                    conn.onerror = (error) => {
                        addToLog("Local websocket connection error");
                    }

                    conn.onopen = () => {
                        addToLog("Connected to local");
                        setWsLocalStatusText('ok', "Open")
                    }
                    
                    conn.onclose = (event) => {
                        addToLog("Disconnected from local");
                        if (event.wasClean) {
                            setWsLocalStatusText('ok', `Closed: Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        } else {
                            // e.g. server process killed or network down
                            // event.code is usually 1006 in this case
                            setWsLocalStatusText('error', 'Closed: Unexpected disconnect');
                        }
                    }

                    conn.onmessage = (evt) => {
                        const msg = JSON.parse(evt.data);
                        switch(msg.type) {
                            case "session-status":
                                console.log(msg)
                                handleMsgServerStatus(msg['session-status']);
                                break;

                            case "log":
                                handleMsgLog(msg.log);
                                break;

                            default:
                                console.error(`Unhandled message type ${msg.type}`);
                        }
                    }
                }

                document.getElementById("start-session").addEventListener("submit", (e) => {
                    e.preventDefault();
                    const data = getDataFromForm(e.target)
                    e.target.reset();

                    addToLog(`Requested Start Session on port: ${data.port}`);
                    (async() => {
                        const res = await ajax.makeReq("POST", "server", {port: data.port, 'session-name': data['session-name']})
                        if (res.ok) {
                            addToLog("Server Started");
                        }
                    })();
                });

                document.getElementById("resume-session").addEventListener("submit", (e) => {
                    e.preventDefault();
                    const data = getDataFromForm(e.target)
                    e.target.reset();
                    console.log(data)

                    addToLog(`Requested Resume Session: ${data['session-slug']}`);
                    (async() => {
                        const res = await ajax.makeReq("POST", "server-resume", {'session-slug': data['session-slug']})
                        if (res.ok) {
                            addToLog("Server Started");
                        }
                    })();
                });

                document.getElementById("setup-machine").addEventListener("submit", (e) => {
                    e.preventDefault();
                    if (!ws.isOpen()) {
                        return false;
                    }

                    const data = getDataFromForm(e.target)
                    e.target.reset();

                    addToLog(`Requested Setup Machine: ${data['slot-id']} ${data['connection']}`);
                    ws.sendMsg("machine-setup", {'slot-id': data['slot-id'], 'connection': data['connection']});
                    return false;
                });
                
                document.getElementById("btn-identify-machines").onclick = () => {
                    if (!ws.isOpen()) {
                        return false;
                    }
                    addToLog(`Sending identifier code to Machines`);
                    ws.sendMsg("identify-machines", {});
                    return false;
                };

                document.getElementById("start-tic-unassigned").addEventListener("click", (e) => {
                    e.preventDefault();
                    addToLog("Requested TIC-80 (unassigned)");
                    (async() => {
                        const res = await ajax.makeReq("POST", "machine", {platform: "TIC-80", mode: "unassigned"})
                        if (res.ok) {
                            addToLog("TIC-80 (unassigned) Started");
                        }
                    })();
                });

                document.getElementById("start-tic-playlist").addEventListener("click", (e) => {
                    e.preventDefault();
                    addToLog("Requested TIC-80 (jukebox)");
                    (async() => {
                        const res = await ajax.makeReq("POST", "machine", {platform: "TIC-80", mode: "jukebox"})
                        if (res.ok) {
                            addToLog("TIC-80 (Jukebox) Started");
                        }
                    })();
                });
            };
        </script>

        <link rel="stylesheet" href="/static/style/default.css" />
    </head>
    <body>
        <div class="container">
            <h1><img src="/static/media/bytejammer-icon.png" alt="ByteJammer icon"> ByteJammer / {{release_title}} edition</h1>

            <div id="section-launch-server">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mt-2 mb-2">
                            <div class="card-header text-bg-primary">
                                <h3>Start New Jam Session</h3>
                            </div>
                            <div class="card-body">
                                <form id="start-session">
                                    <div class="row mb-3">
                                        <label for="port" class="col-sm-3 col-form-label text-end">Port</label>
                                        <div class="col-sm-9">
                                            <input type="number" value="4545" class="form-control" id="port" name="port">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="session-name" class="col-sm-3 col-form-label text-end">Session Name</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="session-name" name="session-name">
                                            <span id="sessionNameHelp" class="form-text">
                                                This is for your own reference only - a directory will be created on your
                                                filesystem using the date and this name, but you don't need to disclose it to
                                                your jammers.
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="offset-sm-3">
                                            <button type="submit" class="btn btn-primary">Start New Jam Session</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>    
                    </div>
                    <div class="col-md-6">
                        <div class="card mt-2 mb-2">
                            <div class="card-header text-bg-primary">
                                <h3>Resume Jam Session</h3>
                            </div>
                            <div class="card-body">
                                <form id="resume-session">
                                    <div class="row mb-3">
                                        <label for="resume-session-slug" class="col-sm-3 col-form-label text-end">Session name</label>
                                        <div class="col-sm-9">
                                            <select class="form-select" aria-label="Default select example" id="resume-session-slug" name="session-slug">
                                                <option selected>(...loading...)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="offset-sm-3">
                                            <button type="submit" class="btn btn-primary">Resume Jam Session</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="section-server-info">
                <div class="card mt-4 mb-4">
                    <div class="card-header text-bg-primary">
                        <h2>Server</h2>
                    </div>
                    <div class="card-body">
                        <div id="server-details"></div>
                    </div>
                </div>

                <div class="card mt-4 mb-4">
                    <div class="card-header text-bg-success">
                        <h2>Jammers</h2>
                    </div>
                    <div class="card-body">
                        <div id="clients"></div>
                    </div>
                </div>

                <div class="card mt-4 mb-4">
                    <div class="card-header text-bg-success">
                        <h2>Slots</h2>
                    </div>
                    <div class="card-body">
                        <div id="slots"></div>
                        <p class="form-text">
                            NB If you remove a machine, it will close, but the jammer will still be connected to your server in case
                            you'd like to reassign them.
                        </p>
                    </div>
                    <div class="card-footer">
                        <form class="row gy-2 gx-3 align-items-center" id="setup-machine">
                            <div class="col-auto">
                                <label class="visually-hidden" for="slot-id">Slot ID</label>
                                <select class="form-select" id="slot-connection" name="slot-id">
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="visually-hidden" for="slot-connection">Connection</label>
                                <select class="form-select" id="slot-connection" name="connection">
                                    <option value="-" selected>(No Machine)</option>
                                    <option value="tic">TIC (no jammer)</option>
                                    <option value="tic:lcdz">TIC (LCDZ playlist)</option>
                                    <option value="tic:@jtruk">Jammer: @jtruk</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary">Create Slot</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-4 mb-4">
                    <div class="card-header text-bg-success">
                        <h2>Machines</h2>
                    </div>
                    <div class="card-body">
                        <div id="machines"></div>
                    </div>
                    <div class="card-footer">
                        <div class="btn-group">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Start Machine
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="start-tic-unassigned">TIC (unassigned)</a></li>
                                <li><a class="dropdown-item" id="start-tic-playlist">TIC (playlist: LCDZ)</a></li>
                            </ul>
                        </div>
                        <button id="btn-identify-machines" class="btn btn-primary">Identify Machines (10s)</button>

                    </div>
                </div>
            </div>

            <div class="card mt-4 mb-4">
                <div class="card-header text-bg-secondary">
                    <h2>Log</h2>
                </div>
                <div class="card-body">
                    <div id="log"></div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom">
            <div class="container" id="connection-status-panel">
                <div>Connection to Local: <span id="ws-local-status">(none)</span></div>
            </div>
        </div>

        <script src="/static/package/bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>    
    </body>
</html>
